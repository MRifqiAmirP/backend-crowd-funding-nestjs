name: ğŸš€ Automation Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout Kode
      uses: actions/checkout@v3

    - name: ğŸ” SSH dan Deploy ke VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -euo pipefail

          echo "ğŸ”§ Load NVM..."
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          echo "ğŸ“ Pindah ke direktori proyek..."
          cd /home/proyeksiswa/crowd-funding/backend-crowd-funding-nestjs

          echo "â¬‡ï¸ Pull perubahan dari Git..."
          git pull origin main

          echo "ğŸ“¦ Cek perubahan dependencies..."
          if git diff --name-only HEAD@{1} HEAD | grep -E 'package(-lock)?\.json'; then
            echo "ğŸ”„ package.json berubah, jalankan npm install..."
            npm install
          else
            echo "âœ… Tidak ada perubahan dependencies."
          fi

          echo "ğŸ›‘ Hentikan proses PM2..."
          pm2 stop all

          echo "ğŸ§® Backup database..."
          mysqldump -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} \
            --no-create-info --skip-triggers \
            --ignore-table=${{ secrets.DB_NAME }}._prisma_migrations \
            ${{ secrets.DB_NAME }} > /tmp/db_data_backup.sql

          echo "ğŸ§¹ Hapus folder migrations..."
          rm -rf ./src/prisma/migrations

          echo "ğŸ” Jalankan prisma:resmig..."
          npm run prisma:resmig

          echo "â™»ï¸ Restore data ke database..."
          mysql -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} ${{ secrets.DB_NAME }} <<EOF
          SET FOREIGN_KEY_CHECKS=0;
          SOURCE /tmp/db_data_backup.sql;
          SET FOREIGN_KEY_CHECKS=1;
          EOF

          echo "âš™ï¸ Jalankan prisma generate dan build..."
          npm run prisma:generate
          npm run build

          echo "ğŸš€ Jalankan ulang PM2..."
          pm2 flush
          pm2 restart all || pm2 start dist/main.js --name backend-dev
          pm2 save